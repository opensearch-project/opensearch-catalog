{
    "AWSTemplateFormatVersion":"2010-09-09", 
    "Description":"OpenSearch Foundational - Dashboards Proxy Stack.  **Attention** This template creates AWS resources that will incur charges on your account.",
    "Parameters":{
        "NetworkStackName": {
            "Description": "Name of an active CloudFormation stack that contains the networking resources.",
            "Type": "String"
        },
        "SearchStackName": {
            "Description": "Name of an active CloudFormation stack that contains the search resources.",
            "Type": "String"
        },
        "CognitoStackName": {
            "Description": "Name of an active CloudFormation stack that contains the cognito resources.",
            "Type": "String"
        }
    },
    "Mappings":{
        "AWSEC2AMILinux":{
            "us-east-1":{"AmiId":"ami-0b0dcb5067f052a63"},
            "us-east-2":{"AmiId":"ami-0beaa649c482330f7"},
            "us-west-1":{"AmiId":"ami-0f5e8a042c8bfcd5e"},
            "us-west-2":{"AmiId":"ami-094125af156557ca2"},
            "ap-south-1":{"AmiId":"ami-074dc0a6f6c764218"},
            "ap-southeast-1":{"AmiId":"ami-0af2f764c580cc1f9"},
            "ap-southeast-2":{"AmiId":"ami-06bb074d1e196d0d4"},
            "ap-northeast-1":{"AmiId":"ami-072bfb8ae2c884cc4"},
            "ap-northeast-2":{"AmiId":"ami-0eddbd81024d3fbdd"},
            "ap-northeast-3":{"AmiId":"ami-0e0cbf0f03ba99ee7"},
            "ca-central-1":{"AmiId":"ami-0ee679ef733e3b8e7"},
            "eu-central-1":{"AmiId":"ami-076309742d466ad69"},
            "eu-west-1":{"AmiId":"ami-01cae1550c0adea9c"},
            "eu-west-2":{"AmiId":"ami-04706e771f950937f"},
            "eu-west-3":{"AmiId":"ami-0f15e0a4c8d3ee5fe"},
            "eu-north-1":{"AmiId":"ami-02aeff1a953c5c2ff"},
            "sa-east-1":{"AmiId":"ami-0b7101e993ea27f3a"}
        }
    },
    "Resources":{
        "ProxySecurityGroup":{
            "Type":"AWS::EC2::SecurityGroup",
            "Properties":{
                "GroupDescription":"Rules for allowing access to the proxy",
                "VpcId" : {"Fn::ImportValue" : {"Fn::Sub": "${NetworkStackName}-VPCID"}},               
                "SecurityGroupIngress":
                [
                    {
                        "Description": "Allow HTTPS access over the internet",
                        "IpProtocol":"tcp",
                        "FromPort":"443",
                        "ToPort":"443",
                        "CidrIp":"0.0.0.0\/0"
                    }
                ],
                "SecurityGroupEgress":
                [
                    {
                        "Description": "Allow proxy to download resources from the internet",
                        "IpProtocol":"-1",
                        "FromPort":"0",
                        "ToPort":"65535",
                        "CidrIp":"0.0.0.0\/0"
                    }
                ],
                "Tags":[
                    {"Key": "Name","Value": {"Fn::Join": ["",[{"Fn::ImportValue" : {"Fn::Sub": "${NetworkStackName}-EnvTag"}},"-dashboards-proxy-sg"]]}}
                ]
            }
        },
        "ProxyIPAddress":{
            "Type":"AWS::EC2::EIP",
            "Properties":{
                "Domain":"vpc"
            }
        },
        "ProxyNetworkInterface":{
            "Type":"AWS::EC2::NetworkInterface",
            "Properties":{
                "Description":"Dashboards Proxy ENI",
                "PrivateIpAddress": {"Fn::Join": ["",[{"Fn::ImportValue" : {"Fn::Sub": "${NetworkStackName}-VPCCIDRPrefix"}},".0.150"]]},
                "GroupSet":[{"Ref":"ProxySecurityGroup"}],
                "SubnetId": {"Fn::ImportValue" : {"Fn::Sub": "${NetworkStackName}-PublicSubnet0"}},
                "Tags":[
                    {"Key": "Name","Value": {"Fn::Join": ["",[{"Fn::ImportValue" : {"Fn::Sub": "${NetworkStackName}-EnvTag"}},"-dashboards-proxy-if"]]}}
                ]
            }
        },
        "AssociateEIPProxy" : {
            "Type" : "AWS::EC2::EIPAssociation",
            "Properties" : {
                "AllocationId" : { "Fn::GetAtt" : [ "ProxyIPAddress", "AllocationId" ]},
                "NetworkInterfaceId" : { "Ref" : "ProxyNetworkInterface" }
            }
        },
        "ProxyRole":{
            "Type":"AWS::IAM::Role",
            "Properties":{
                "RoleName": { "Fn::Join": [ "", [ {"Fn::ImportValue" : {"Fn::Sub": "${NetworkStackName}-EnvTag"}}, "-dashboards-proxy-role"]]},
                "AssumeRolePolicyDocument":{
                    "Version":"2012-10-17",
                    "Statement":[{
                       "Effect":"Allow",
                       "Principal":{"Service":["ec2.amazonaws.com"]},
                       "Action":["sts:AssumeRole"]
                    }]
                },
                "Path":"/",
                "ManagedPolicyArns":["arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore"],
                "Policies": [{
                    "PolicyName": { "Fn::Join": [ "", [ {"Fn::ImportValue" : {"Fn::Sub": "${NetworkStackName}-EnvTag"}}, "-dashboards-proxy-policy"]]},
                    "PolicyDocument": {
                        "Version": "2012-10-17",
                        "Statement": [
                            {
                                "Effect":"Allow",
                                "Action":"ec2:Describe*",
                                "Resource":"*"
                            },
                            {
                                "Effect": "Allow",
                                "Action": ["es:ESHttp*"],
                                "Resource": {"Fn::Join":["",["arn:aws:es:",{"Ref":"AWS::Region"},":",{"Ref":"AWS::AccountId"},":domain/",{"Fn::ImportValue" : {"Fn::Sub": "${SearchStackName}-SearchDomainName"}},"/*"]]}
                            }
                        ]
                    }
                }]
            }
        },  
        "ProxyInstanceProfile":{
            "Type": "AWS::IAM::InstanceProfile",
            "Properties": {
                "Path": "/",
                "Roles": [{"Ref": "ProxyRole"}]
            }   
        },      
        "DashboardsProxy":{
            "Type":"AWS::EC2::Instance",
            "Metadata":{
                "Comment":"Install a simple application",
                "AWS::CloudFormation::Init":{
                    "configSets":{
                        "default":["step1","step2"]
                    },
                    "step1":{
                        "files":{
                            "/usr/share/es-scripts/es-proxy-downloader.sh":{
                                "content":{
                                    "Fn::Join":[
                                        "",
                                        [
                                            "curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.3/install.sh | bash\n",
                                            ". ~/.nvm/nvm.sh\n",
                                            "nvm install 16\n",
                                            "npm install -g npm@9.6.2\n",
                                            "npm install aws-es-curl -g\n",
                                            "aws-es-curl --region ",
                                            {"Ref":"AWS::Region"},
                                            " -X GET 'https://",
                                            {"Fn::ImportValue" : {"Fn::Sub": "${SearchStackName}-SearchEndpoint"}},
                                            "/'\n"
                                        ]
                                    ]
                                },
                                "mode":"000755",
                                "owner":"root",
                                "group":"root"
                            }                               
                        }               
                    },
                    "step2":{
                        "packages":{
                            "yum":{
                                "nginx":[]
                            }
                        },
                        "files":{
                            "/etc/nginx/conf.d/default.conf":{
                                "content":{
                                    "Fn::Join":[
                                        "",
                                        [
                                            "server {\n",
                                            "    listen 443;\n",
                                            "    server_name $host;\n",
                                            "    rewrite ^/$ https://$host/_dashboards redirect;\n",
                                            "\n", 
                                            "    ssl_certificate           /etc/nginx/cert.crt;\n",
                                            "    ssl_certificate_key       /etc/nginx/cert.key;\n",
                                            "\n", 
                                            "    client_max_body_size 100M;\n",
                                            "\n", 
                                            "    ssl on;\n",
                                            "    ssl_session_cache  builtin:1000  shared:SSL:10m;\n",
                                            "    ssl_protocols  TLSv1 TLSv1.1 TLSv1.2;\n",
                                            "    ssl_ciphers HIGH:!aNULL:!eNULL:!EXPORT:!CAMELLIA:!DES:!MD5:!PSK:!RC4;\n",
                                            "    ssl_prefer_server_ciphers on;\n",
                                            "\n", 
                                            "    # local variables for host resolution for the DNS timeouts.  Use variable to resolve intead of URI which grabs once\n",
                                            "    # ...it will uses DNS resolver in case cached entry for the IP has expired\n",
                                            "    set $es_endpoint ",                                                             
                                            {"Fn::ImportValue" : {"Fn::Sub": "${SearchStackName}-SearchEndpoint"}},
                                            ";\n",
                                            "    set $cognito_endpoint ",                                                             
                                            {"Fn::ImportValue" : {"Fn::Sub": "${CognitoStackName}-CognitoUserPoolEndpoint"}},
                                            ";\n", 
                                            "\n", 
                                            "    # resolver settings to avoid cache issues with DNS resolution and Amazon ES\n",
                                            "    resolver ",
                                            {"Fn::Join": ["",[{"Fn::ImportValue" : {"Fn::Sub": "${NetworkStackName}-VPCCIDRPrefix"}},".0.2"]]},
                                            " 169.254.169.253 ipv6=off valid=30s;",
                                            "\n", 
                                            "    location ^~ /_dashboards {\n",
                                            "        # Forward requests to Dashboards\n",
                                            "        proxy_pass https://$es_endpoint;\n",
                                            "\n", 
                                            "        # Handle redirects to Amazon Cognito\n",
                                            "        proxy_redirect https://$cognito_endpoint https://$host;\n",
                                            "\n", 
                                            "        # Update cookie domain and path\n",
                                            "        proxy_cookie_domain $es_endpoint $host;\n",
                                            "\n", 
                                            "        proxy_set_header Accept-Encoding \"\";\n",
                                            "        sub_filter_types *;\n",
                                            "        sub_filter $es_endpoint $host;\n",
                                            "        sub_filter_once off;\n",
                                            "\n", 
                                            "        # Response buffer settings\n",
                                            "        proxy_buffer_size 128k;\n",
                                            "        proxy_buffers 4 256k;\n",
                                            "        proxy_busy_buffers_size 256k;\n",
                                            "    }\n",
                                            "\n",               
                                            "    location ~ \\/(log|sign|error|fav|forgot|change|oauth2|saml) {\n",
                                            "        # Forward requests to Cognito\n",
                                            "        proxy_pass https://$cognito_endpoint;\n",
                                            "\n", 
                                            "        # Handle redirects to Dashboards\n",
                                            "        proxy_redirect https://$es_endpoint https://$host;\n",
                                            "\n", 
                                            "        # Handle redirects to Amazon Cognito\n",
                                            "        proxy_redirect https://$cognito_endpoint https://$host;\n",
                                            "\n", 
                                            "        # Update cookie domain\n",
                                            "        proxy_cookie_domain $cognito_endpoint $host;\n",
                                            "    }\n",
                                            "}\n"
                                        ]
                                    ]         
                                },
                                "mode":"000644",
                                "owner":"root",
                                "group":"root"
                            }
                        },
                        "services":{
                            "sysvinit":{
                                "amazon-ssm-agent":{
                                    "enabled":"true",
                                    "ensureRunning":"true"
                                },
                                "nginx":{
                                    "enabled":"true",
                                    "ensureRunning":"true"
                                }                              
                            }
                        }
                    }
                }
            },
            "Properties":{
                "Tags":[
                    {"Key": "Name","Value": {"Fn::Join": ["",[{"Fn::ImportValue" : {"Fn::Sub": "${NetworkStackName}-EnvTag"}},"-dashboards-proxy"]]}}
                ],                            
                "ImageId":{
                    "Fn::FindInMap":[
                        "AWSEC2AMILinux",
                        {"Ref":"AWS::Region"},
                        "AmiId"
                    ]
                },
                "InstanceType":"c5.large",
                "IamInstanceProfile":{ "Ref":"ProxyInstanceProfile"},
                "UserData":{
                    "Fn::Base64":{
                        "Fn::Join":[
                            "",
                            [
                                "#!/bin/bash -xe\n",
                                "yum update -y aws-cfn-bootstrap\n",
                                "yum update -y aws-cli\n",
                                "yum update -y amazon-ssm-agent\n",
                                "mkdir /usr/share/es-scripts\n",
                                "amazon-linux-extras install nginx1.12 -y\n",
                                "openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout /etc/nginx/cert.key -out /etc/nginx/cert.crt -subj /C=US/ST=./L=./O=./CN=.\n",
                                "yum install -y python-pip\n",
                                "/opt/aws/bin/cfn-init -c default -v ",
                                "         --stack ",
                                {
                                    "Ref":"AWS::StackName"
                                },
                                "         --resource DashboardsProxy ",
                                "         --region ",
                                {
                                    "Ref":"AWS::Region"
                                },
                                "\n"
                            ]
                        ]
                    }
                    
                },    
                "NetworkInterfaces":[
                    {
                        "DeviceIndex":"0",
                        "NetworkInterfaceId":{"Ref":"ProxyNetworkInterface"}
                    }
                ]
            }
        },
        "OSInitLambdaRole": {
            "Type": "AWS::IAM::Role",
            "Properties": {
            "RoleName": { 
                "Fn::Join": [ "", [ {"Fn::ImportValue" : {"Fn::Sub": "${NetworkStackName}-EnvTag"}}, "-OS_INIT-role"]]
            },
            "AssumeRolePolicyDocument": {
                "Version": "2012-10-17",
                "Statement": [
                {
                    "Effect": "Allow",
                    "Principal": {
                    "Service": "lambda.amazonaws.com"
                    },
                    "Action": "sts:AssumeRole"
                }
                ]
            },
            "ManagedPolicyArns": [
                "arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole",
                "arn:aws:iam::aws:policy/AmazonS3ReadOnlyAccess"
            ],
            "Policies": [
                {
                "PolicyName": { "Fn::Join": [ "", [ {"Fn::ImportValue" : {"Fn::Sub": "${NetworkStackName}-EnvTag"}}, "-dashboards-proxy-policy"]]},
                "PolicyDocument": {
                    "Version": "2012-10-17",
                    "Statement": [
                        {
                            "Effect":"Allow",
                            "Action":"ec2:Describe*",
                            "Resource":"*"
                        },
                        {
                            "Effect": "Allow",
                            "Action": ["es:ESHttp*"],
                            "Resource": {"Fn::Join":["",["arn:aws:es:",{"Ref":"AWS::Region"},":",{"Ref":"AWS::AccountId"},":domain/",{"Fn::ImportValue" : {"Fn::Sub": "${SearchStackName}-SearchDomainName"}},"/*"]]}
                        }
                    ]
                }
            }
        ]
        }
            },     
        "OSInitLambdaFunction": {
            "Type": "AWS::Lambda::Function",
            "Properties": {
                "FunctionName": {
                    "Fn::Join": ["",[{"Fn::ImportValue" : {"Fn::Sub": "${NetworkStackName}-EnvTag"}},"-OS_INIT"]]
                },
                "Handler": "os_init_function.lambda_handler",
                "Runtime": "python3.12",
                "Code": {
                    "S3Bucket": "os-cluster-cfn-staging-bucket-1234",
                    "S3Key": "assets/os_init_function.py.zip"
                },
                "VpcConfig": {
                    "SecurityGroupIds": [
                        {
                          "Ref": "ProxySecurityGroup"
                        }
                    ],
                "SubnetIds": {
                    "Fn::Split": [
                    ",",
                    {
                        "Fn::Join": [
                        ",",
                        [
                            {
                            "Fn::ImportValue": {
                                "Fn::Sub": "${NetworkStackName}-PrivateSubnetApp0"
                            }
                            },
                            {
                            "Fn::ImportValue": {
                                "Fn::Sub": "${NetworkStackName}-PrivateSubnetApp1"
                            }
                            }
                        ]
                        ]
                    }
                    ]
                }
            },
            "MemorySize": 256,
            "Timeout": 180,
            "Environment": {
                "Variables": {
                "ES_ENDPOINT": {
                    "Fn::Join": [
                        "",
                        [
                        "https://",
                        {
                            "Fn::ImportValue": {
                            "Fn::Sub": "${SearchStackName}-SearchEndpoint"}
                        }
                    ]
                ]
                },
                "ES_USERNAME": "",
                "SENSITIVE_ES_PASSWORD": ""
                }
            },
            "Role": {
                "Fn::GetAtt": [
                  "OSInitLambdaRole",
                  "Arn"]
            }
        }
        }
    },
    "Outputs":{
        "DashboardsProxyRoleArn":{
            "Description":"Dashboards proxy role ARN for FGAC role mapping.",
            "Value": {"Fn::GetAtt" : ["ProxyRole", "Arn"] },
            "Export" : { "Name" : {"Fn::Sub": "${AWS::StackName}-DashboardsProxyRoleArn" }}
        },  
        "DashboardsProxyURL":{
            "Description":"Dashboards Proxy Public IP address.",
            "Value": {"Fn::Join":["",["https://",{"Ref":"ProxyIPAddress"},"/_dashboards"]]},       
            "Export" : { "Name" : {"Fn::Sub": "${AWS::StackName}-DashboardsProxyURL" }}
        }
    }
}    

